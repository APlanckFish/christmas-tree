# ğŸš€ å¿«é€Ÿå¯åŠ¨æŒ‡å—ï¼ˆä½¿ç”¨ Nginx å¤„ç† SSLï¼‰

æœ¬æ–‡æ¡£æä¾›ä½¿ç”¨ Nginx å¤„ç† SSL çš„å¿«é€Ÿå¯åŠ¨æ­¥éª¤ã€‚

## ğŸ“‹ å‰ç½®è¦æ±‚

- Docker å’Œ Docker Compose å·²å®‰è£…
- Nginx å·²å®‰è£…
- SSL è¯ä¹¦å·²å‡†å¤‡å¥½ï¼ˆLet's Encrypt æˆ–å…¶ä»–è¯ä¹¦ï¼‰

## ğŸš€ å¿«é€Ÿå¯åŠ¨æ­¥éª¤

### 1. å‡†å¤‡é¡¹ç›®æ–‡ä»¶

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/christmas-tree  # æˆ–ä½ çš„é¡¹ç›®è·¯å¾„
```

### 2. æ„å»º Docker é•œåƒ

```bash
docker-compose -f docker-compose.prod.yml build
```

### 3. å¯åŠ¨å®¹å™¨

```bash
docker-compose -f docker-compose.prod.yml up -d
```

### 4. éªŒè¯å®¹å™¨è¿è¡Œ

```bash
# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f

# æµ‹è¯•æœ¬åœ°è¿æ¥
curl http://127.0.0.1:8080
```

### 5. é…ç½® Nginx

#### 5.1 å¤åˆ¶é…ç½®æ–‡ä»¶

```bash
# å¤åˆ¶ç¤ºä¾‹é…ç½®
sudo cp nginx.conf.example /etc/nginx/sites-available/christmas-tree

# ç¼–è¾‘é…ç½®ï¼ˆæ›¿æ¢åŸŸåå’Œè¯ä¹¦è·¯å¾„ï¼‰
sudo nano /etc/nginx/sites-available/christmas-tree
```

#### 5.2 ä¿®æ”¹é…ç½®

åœ¨é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹ä»¥ä¸‹å†…å®¹ï¼š

1. **åŸŸå**ï¼šå°† `yourdomain.com` æ›¿æ¢ä¸ºä½ çš„å®é™…åŸŸå
2. **è¯ä¹¦è·¯å¾„**ï¼šæ ¹æ®ä½ çš„è¯ä¹¦ä½ç½®ä¿®æ”¹è·¯å¾„
   - Let's Encrypt: `/etc/letsencrypt/live/yourdomain.com/`
   - å…¶ä»–è¯ä¹¦: ä¿®æ”¹ä¸ºå®é™…è·¯å¾„

#### 5.3 å¯ç”¨é…ç½®

```bash
# åˆ›å»ºç¬¦å·é“¾æ¥
sudo ln -s /etc/nginx/sites-available/christmas-tree /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡è½½ Nginx
sudo systemctl reload nginx
```

### 6. éªŒè¯éƒ¨ç½²

```bash
# æµ‹è¯• HTTPS è®¿é—®
curl -I https://yourdomain.com

# åœ¨æµè§ˆå™¨ä¸­è®¿é—®
# https://yourdomain.com
```

## ğŸ”§ å¸¸ç”¨å‘½ä»¤

### æŸ¥çœ‹æ—¥å¿—

```bash
# å®¹å™¨æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f

# Nginx è®¿é—®æ—¥å¿—
sudo tail -f /var/log/nginx/christmas-tree-access.log

# Nginx é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/christmas-tree-error.log
```

### é‡å¯æœåŠ¡

```bash
# é‡å¯å®¹å™¨
docker-compose -f docker-compose.prod.yml restart

# é‡å¯ Nginx
sudo systemctl restart nginx
```

### åœæ­¢æœåŠ¡

```bash
# åœæ­¢å®¹å™¨
docker-compose -f docker-compose.prod.yml down

# åœæ­¢ Nginxï¼ˆå¦‚æœéœ€è¦ï¼‰
sudo systemctl stop nginx
```

### æ›´æ–°åº”ç”¨

```bash
# æ‹‰å–æœ€æ–°ä»£ç 
git pull

# é‡æ–°æ„å»º
docker-compose -f docker-compose.prod.yml build

# é‡å¯æœåŠ¡
docker-compose -f docker-compose.prod.yml up -d
```

## ğŸ” æ•…éšœæ’æŸ¥

### å®¹å™¨æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
docker-compose -f docker-compose.prod.yml logs

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep 8080
```

### Nginx 502 é”™è¯¯

- æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œï¼š`docker-compose -f docker-compose.prod.yml ps`
- æ£€æŸ¥å®¹å™¨æ—¥å¿—ï¼š`docker-compose -f docker-compose.prod.yml logs`
- æ£€æŸ¥ Nginx é”™è¯¯æ—¥å¿—ï¼š`sudo tail -f /var/log/nginx/christmas-tree-error.log`

### WebSocket è¿æ¥å¤±è´¥

- ç¡®ä¿ Nginx é…ç½®ä¸­çš„ `/ws` location å—æ­£ç¡®é…ç½®äº† WebSocket å‡çº§å¤´
- æ£€æŸ¥ `proxy_set_header Upgrade` å’Œ `proxy_set_header Connection` æ˜¯å¦æ­£ç¡®è®¾ç½®
- æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°çš„ WebSocket é”™è¯¯ä¿¡æ¯

### SSL è¯ä¹¦é—®é¢˜

```bash
# æ£€æŸ¥è¯ä¹¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
sudo ls -la /etc/letsencrypt/live/yourdomain.com/

# æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ
sudo openssl x509 -in /etc/letsencrypt/live/yourdomain.com/fullchain.pem -noout -dates

# æµ‹è¯• Nginx é…ç½®
sudo nginx -t
```

## ğŸ“ é…ç½®è¯´æ˜

### ç«¯å£é…ç½®

- **å®¹å™¨å†…ç«¯å£**ï¼š8080ï¼ˆHTTPï¼‰
- **ä¸»æœºç«¯å£**ï¼š127.0.0.1:8080ï¼ˆä»…æœ¬åœ°è®¿é—®ï¼Œç”± Nginx ä»£ç†ï¼‰
- **Nginx ç«¯å£**ï¼š80ï¼ˆHTTPï¼‰å’Œ 443ï¼ˆHTTPSï¼‰

### ç¯å¢ƒå˜é‡

å®¹å™¨ä½¿ç”¨ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼ˆåœ¨ `docker-compose.prod.yml` ä¸­é…ç½®ï¼‰ï¼š

- `NODE_ENV=production`
- `PORT=8080`
- `WS_PORT=8080`
- `SSL_KEY_PATH=`ï¼ˆç©ºï¼Œä¸ä½¿ç”¨å®¹å™¨å†…è¯ä¹¦ï¼‰
- `SSL_CERT_PATH=`ï¼ˆç©ºï¼Œä¸ä½¿ç”¨å®¹å™¨å†…è¯ä¹¦ï¼‰

## ğŸ”’ å®‰å…¨å»ºè®®

1. **é˜²ç«å¢™**ï¼šåªå¼€æ”¾ 80 å’Œ 443 ç«¯å£
2. **å®¹å™¨å®‰å…¨**ï¼šå®¹å™¨åªç›‘å¬ 127.0.0.1ï¼Œä¸å¯¹å¤–æš´éœ²
3. **è¯ä¹¦ç»­æœŸ**ï¼šå¦‚æœä½¿ç”¨ Let's Encryptï¼Œè®¾ç½®è‡ªåŠ¨ç»­æœŸ
4. **å®šæœŸæ›´æ–°**ï¼šä¿æŒ Docker é•œåƒå’Œä¾èµ–æ›´æ–°

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æ£€æŸ¥å®¹å™¨æ—¥å¿—ï¼š`docker-compose -f docker-compose.prod.yml logs -f`
2. æ£€æŸ¥ Nginx æ—¥å¿—ï¼š`sudo tail -f /var/log/nginx/christmas-tree-error.log`
3. æµ‹è¯• Nginx é…ç½®ï¼š`sudo nginx -t`
4. æŸ¥çœ‹å®¹å™¨çŠ¶æ€ï¼š`docker-compose -f docker-compose.prod.yml ps`

