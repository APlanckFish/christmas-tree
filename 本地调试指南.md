# 🧪 本地调试测试指南

## 📋 前置准备

### 1. 安装依赖

```bash
npm install
```

### 2. 生成 HTTPS 证书（可选，但推荐）

WebRTC 需要 HTTPS 环境（localhost 除外）。开发环境建议生成自签名证书：

```bash
chmod +x generate-cert.sh
./generate-cert.sh
```

生成后会在项目根目录创建：
- `localhost-key.pem` (私钥)
- `localhost.pem` (证书)

**注意**: 首次访问需要信任证书：
- **Chrome/Edge**: 访问 `https://localhost:5173`，点击"高级" → "继续访问"
- **Safari**: 系统偏好设置 → 钥匙串访问 → 添加证书并信任

## 🚀 启动开发服务器

### 方式一：使用 npm 脚本（推荐）

```bash
npm run dev
```

这会同时启动：
- **React Router 开发服务器** (端口 5173)
- **WebSocket 服务器** (端口 3001)

### 方式二：使用开发脚本

```bash
chmod +x dev.sh
./dev.sh
```

### 方式三：分别启动（用于调试）

**终端 1 - WebSocket 服务器：**
```bash
npm run dev:ws
```

**终端 2 - React Router 开发服务器：**
```bash
npm run dev:app
```

## 🌐 访问地址

启动成功后，你会看到类似输出：

```
🌐 Access URLs:
   Local:   http://localhost:5173
   Network: http://192.168.x.x:5173

🔌 WebSocket Server:
   ws://localhost:3001/ws
```

### PC 端访问

- **HTTP**: `http://localhost:5173`
- **HTTPS**: `https://localhost:5173` (需要证书)

### 手机端访问

确保手机和 PC 在同一局域网：

1. 查看控制台输出的 IP 地址（如 `192.168.1.100`）
2. 在手机浏览器访问：`http://192.168.1.100:5173`
3. 或者扫描 PC 端显示的二维码

## 🧪 测试步骤

### 1. 测试本地摄像头控制

1. 打开 `http://localhost:5173`
2. 允许浏览器访问摄像头权限
3. 将手放在摄像头前
4. 测试手势：
   - **闭合拳头** → 树形状
   - **张开手掌** → 粒子散开
   - **捏合拇指和食指** → 聚焦照片
   - **在散开模式下移动手** → 控制旋转

### 2. 测试手机摄像头串流

#### 步骤 A：PC 端操作

1. 点击页面底部的"📱 连接手机摄像头"按钮
2. 弹出二维码弹窗
3. 如果需要，配置服务器 IP（通常自动检测）
4. 等待连接...

#### 步骤 B：手机端操作

1. 使用手机扫描二维码
2. 或直接访问：`http://[PC的IP]:5173/phone-camera?room=[房间ID]`
3. 允许摄像头权限
4. 等待连接建立

#### 步骤 C：验证连接

- PC 端左下角显示手机摄像头画面
- 手机端显示"✅ Connected! Streaming video..."
- 使用手机摄像头的手势可以控制 PC 端的圣诞树

### 3. 测试照片上传

1. 点击"Add Memories"按钮
2. 选择图片文件（支持多选）
3. 照片会出现在圣诞树上
4. 使用捏合手势可以聚焦查看照片

### 4. 测试背景音乐

- 页面加载后自动播放背景音乐
- 如果浏览器阻止自动播放，点击页面任意位置即可播放

### 5. 测试 UI 隐藏

- 按 `H` 键隐藏/显示控制界面
- 标题和按钮会淡出/淡入

## 🔍 调试技巧

### 查看控制台日志

打开浏览器开发者工具（F12），查看 Console：

- `[IP Detection]` - IP 检测日志
- `[QRCode]` - 二维码生成日志
- `[Connection]` - WebRTC 连接日志
- `[Camera]` - 摄像头状态日志
- `[MediaPipe]` - 手势识别日志
- `[ChristmasTree]` - 3D 渲染日志

### 检查 WebSocket 连接

在浏览器控制台执行：

```javascript
// 检查 WebSocket 连接状态
console.log('WebSocket:', window.wsRef?.readyState);
```

### 检查 WebRTC 连接

```javascript
// 检查 PeerConnection 状态
console.log('Connection State:', window.pcRef?.connectionState);
console.log('ICE State:', window.pcRef?.iceConnectionState);
```

### 网络调试

1. **Chrome DevTools** → Network 标签
   - 查看 WebSocket 连接
   - 查看资源加载情况

2. **Chrome DevTools** → Application → WebRTC
   - 查看 WebRTC 连接详情
   - 查看 ICE candidates

## ⚠️ 常见问题

### 1. 摄像头无法访问

**问题**: 浏览器提示"无法访问摄像头"

**解决**:
- 检查浏览器权限设置
- 确保使用 HTTPS 或 localhost
- 检查是否有其他应用占用摄像头

### 2. WebRTC 连接失败

**问题**: 手机和 PC 无法建立连接

**解决**:
- 确保 PC 和手机在同一网络
- 检查防火墙设置（允许端口 3001）
- 尝试使用 PC 的局域网 IP 而非 localhost
- 检查 WebSocket 服务器是否正常运行

### 3. 手势识别不工作

**问题**: 手势无法控制圣诞树

**解决**:
- 确保摄像头已启动并正常工作
- 检查 MediaPipe 是否加载成功（查看控制台）
- 确保手在摄像头视野内，距离 30-50cm
- 检查光照条件（避免过暗或过亮）

### 4. 二维码无法扫描

**问题**: 手机扫描二维码后无法连接

**解决**:
- 确保手机和 PC 在同一网络
- 检查二维码中的 IP 地址是否正确
- 尝试手动输入 URL
- 检查 WebSocket 服务器端口（3001）是否可访问

### 5. HTTPS 证书错误

**问题**: 浏览器提示证书不安全

**解决**:
- 信任自签名证书（见前置准备）
- 或使用 HTTP（仅限 localhost）
- 生产环境使用正式证书

### 6. 端口被占用

**问题**: 端口 5173 或 3001 已被占用

**解决**:
```bash
# macOS/Linux 查看端口占用
lsof -i :5173
lsof -i :3001

# 杀死占用进程
kill -9 [PID]
```

## 🛠️ 开发工具推荐

1. **Chrome DevTools**
   - Network 标签查看网络请求
   - Application → WebRTC 查看连接状态
   - Console 查看日志

2. **React DevTools**
   - 安装 Chrome 扩展
   - 查看组件状态和 props

3. **Vite DevTools**
   - 查看构建和热更新状态

## 📝 测试清单

- [ ] 本地摄像头可以正常启动
- [ ] 手势识别正常工作（三种手势模式）
- [ ] 手势可以控制树的旋转（SCATTER 模式）
- [ ] 照片上传功能正常
- [ ] 背景音乐可以播放
- [ ] UI 隐藏/显示功能正常
- [ ] 二维码可以正常生成
- [ ] 手机可以扫描二维码连接
- [ ] WebRTC 连接可以建立
- [ ] 手机摄像头画面可以显示在 PC 端
- [ ] 手机手势可以控制 PC 端圣诞树
- [ ] 切换摄像头控制源功能正常

## 🎯 快速测试命令

```bash
# 一键启动（推荐）
npm run dev

# 仅启动 WebSocket 服务器
npm run dev:ws

# 仅启动 React Router 开发服务器
npm run dev:app

# 构建生产版本
npm run build

# 启动生产服务器
npm start
```

## 💡 提示

1. **首次运行**: 建议先测试本地摄像头功能，再测试手机串流
2. **网络环境**: 开发环境支持局域网，生产环境需要公网
3. **性能优化**: 如果 3D 渲染卡顿，可以降低粒子数量（修改 `CONFIG.particles.count`）
4. **调试模式**: 所有关键操作都有控制台日志，便于排查问题

---

**需要帮助？** 查看控制台日志，大部分问题都有详细的错误信息。

