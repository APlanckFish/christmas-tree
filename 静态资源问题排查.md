# 静态资源问题排查指南

## 问题描述
部署后页面报错：
- `The page /assets/entry.client-BRIwQpHT.js doesn't exist.`
- `Failed to load module script: Expected a JavaScript module script but the server responded with a MIME type of "text/html"`

## 可能原因

### 1. 构建产物未正确复制到容器
React Router v7 构建后会生成：
- `build/server/` - 服务端代码
- `build/client/` - 客户端静态资源（包含 `/assets/` 目录）

### 2. 路径配置问题
React Router v7 的 `createRequestListener` 会自动处理 `build/client` 目录下的静态资源，但需要确保路径正确。

## 排查步骤

### 步骤 1: 检查容器内的构建产物

```bash
# 进入容器
docker exec -it christmas-tree sh

# 检查构建目录结构
ls -la /app/build/
ls -la /app/build/client/
ls -la /app/build/client/assets/ 2>/dev/null || echo "assets 目录不存在"

# 检查具体的 JS 文件
find /app/build/client -name "*.js" | head -5
```

**预期结果：**
- `/app/build/client/` 目录存在
- `/app/build/client/assets/` 目录存在
- 包含 `entry.client-*.js` 文件

### 步骤 2: 查看服务器启动日志

```bash
# 查看容器日志
docker-compose -f docker-compose.prod.yml logs -f christmas-tree

# 应该看到：
# ✅ Loaded build from: /app/build/server/index.js
# ✅ Client build directory exists: /app/build/client
#    Client files: assets, index.html, ...
```

### 步骤 3: 测试静态资源访问

```bash
# 在容器内测试
docker exec -it christmas-tree sh
curl http://127.0.0.1:8080/assets/entry.client-*.js

# 或者通过 Nginx 测试（如果已配置）
curl https://yourdomain.com/assets/entry.client-*.js
```

**预期结果：** 返回 JavaScript 代码，而不是 HTML 404 页面

### 步骤 4: 检查浏览器网络请求

1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 刷新页面
4. 查看失败的 `.js` 文件请求：
   - **请求 URL**: 应该是 `/assets/entry.client-*.js`
   - **状态码**: 应该是 `200`，如果是 `404` 说明文件不存在
   - **响应内容**: 应该是 JavaScript 代码，如果是 HTML 说明返回了 404 页面

### 步骤 5: 检查 Nginx 配置（如果使用）

确保 Nginx 配置不会干扰静态资源：

```nginx
# 静态文件和 API
location / {
    proxy_pass http://127.0.0.1:8888;
    # ... 其他配置 ...
    # 不要覆盖 Content-Type，让后端服务器设置
}
```

## 解决方案

### 方案 1: 重新构建并部署

```bash
# 1. 停止容器
docker-compose -f docker-compose.prod.yml down

# 2. 重新构建（确保构建成功）
docker-compose -f docker-compose.prod.yml build --no-cache

# 3. 启动容器
docker-compose -f docker-compose.prod.yml up -d

# 4. 查看日志
docker-compose -f docker-compose.prod.yml logs -f
```

### 方案 2: 检查构建过程

在本地测试构建：

```bash
# 清理旧的构建
rm -rf build

# 重新构建
npm run build

# 检查构建产物
ls -la build/
ls -la build/client/
ls -la build/client/assets/
```

### 方案 3: 验证 Dockerfile 构建阶段

确保构建阶段成功生成了所有文件：

```dockerfile
# 在 Dockerfile 的构建阶段添加验证
RUN npm run build && \
    ls -la /app/build/ && \
    ls -la /app/build/client/ && \
    ls -la /app/build/client/assets/ || echo "⚠️  assets 目录不存在"
```

## 常见问题

### Q: 为什么 `/assets/` 路径找不到文件？

A: React Router v7 会将静态资源放在 `build/client/assets/` 目录下，`createRequestListener` 会自动将 `/assets/` 请求映射到 `build/client/assets/` 目录。如果文件不存在，可能是：
1. 构建失败或未完成
2. 文件未正确复制到容器
3. 路径配置错误

### Q: 为什么返回 HTML 而不是 JavaScript？

A: 当服务器找不到请求的文件时，React Router 可能会返回 `index.html`（用于客户端路由），但浏览器期望的是 JavaScript 文件。这通常意味着：
1. 静态资源文件不存在
2. 路径映射错误
3. Nginx 配置干扰了请求

### Q: 如何确认文件确实存在？

A: 在容器内执行：
```bash
docker exec -it christmas-tree sh
find /app/build/client -name "entry.client-*.js"
```

如果找不到文件，说明构建或复制过程有问题。

## 下一步

如果以上步骤都无法解决问题，请提供：
1. 容器日志（特别是启动时的日志）
2. `docker exec -it christmas-tree ls -la /app/build/client/` 的输出
3. 浏览器 Network 标签中失败的请求详情
4. 本地 `npm run build` 后的 `build/client/` 目录内容

